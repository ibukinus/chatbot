# OpenProject - Rocket.Chat 連携プロキシ実装仕様書

## 1. 目的
OpenProject のワークパッケージ（WP）でコメントが投稿された際、中間プロキシを介して Rocket.Chat の特定のチャンネルに通知を転送する。その際、ユーザーメンションの変換と、プロジェクトごとの投稿先チャンネルの動的振り分けを行う。

## 2. システム構成
- **送信元**: OpenProject (オンプレミス)
- **仲介**: Python プロキシスクリプト (Docker コンテナ)
- **送信先**: Rocket.Chat (オンプレミス / Incoming Webhook 使用)



## 3. マッピングデータ仕様 (CSV)
以下の 2 種類の CSV ファイルを読み込み、変換ロジックに使用する。ファイルは半年周期で更新される。

### 3.1 `users.csv` (ユーザー変換用)
OpenProject のユーザー名を Rocket.Chat のユーザー名に紐付ける。
| openproject_user | rocketchat_user |
| :--- | :--- |
| tanaka_op | tanaka.taro |
| suzuki_op | suzuki_rc |

### 3.2 `projects.csv` (チャンネル振り分け用)
OpenProject のプロジェクト識別子を Rocket.Chat のチャンネル名に紐付ける。
| project_identifier | rc_channel |
| :--- | :--- |
| system-dev | #dev-alerts |
| infra-project | #infra-log |

## 4. 処理ロジック詳細

### 4.1 Webhook の受信
- **エンドポイント**: `POST /webhook`
- **フィルタリング**: ペイロード内に `work_package` および `journal.notes` (コメント本文) が存在する場合のみ処理を続行する。それ以外は無視する。

### 4.2 メンション変換
1. コメント本文（`notes`）から、`@@ユーザー名` という形式を正規表現（例: `r"@@([\w\.-]+)"`）で抽出する。
2. 抽出したユーザー名を `users.csv` で照合する。
3. 一致するものがあれば、`@rocketchat_user` 形式に置換する。
4. 一致しない場合は、`@ユーザー名` 形式（`@@` を単一の `@` に変更）に置換してフォールバックする。

### 4.3 動的ルーティング (投稿先チャンネルの決定)
1. ペイロードから `project.identifier` を抽出する。
2. `projects.csv` で照合し、対応する `rc_channel` を取得する。
3. 一致しない場合は、環境変数で指定された `DEFAULT_CHANNEL` を使用する。

### 4.4 Rocket.Chat への送信ペイロード
Rocket.Chat の Incoming Webhook の設定を上書きするため、必ず JSON ペイロードに `channel` フィールドを含めること。

**ペイロード形式:**
```json
{
  "channel": "#プロジェクトごとに判定したチャンネル名",
  "text": "### [WP件名] (#ID)\n\n変換後のコメント本文",
  "alias": "OpenProject",
  "icon_emoji": ":clipboard:"
}
